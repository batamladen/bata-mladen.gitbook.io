# Event Tracing for Windows (ETW)

## Overview

Event Tracing for Windows (ETW) is a high-performance event tracing framework in Windows that enables real-time monitoring, logging, and analysis of system and application events. It is a valuable tool for threat detection, incident response, and forensic investigations.

## Key Features of ETW

* **High-speed tracing**: ETW operates with minimal performance impact, allowing real-time event logging.
* **Extensive event coverage**: Logs system calls, process activity, network events, file modifications, and more.
* **Flexible architecture**: Supports both kernel-mode and user-mode event providers.
* **Customizable logging**: Users can define and enable event providers tailored to their security and monitoring needs.
* **Seamless integration**: Works with Microsoft tools such as PowerShell (`Get-WinEvent`) and Message Analyzer for event retrieval and analysis.

***

## ETW Architecture & Components

<figure><img src="../../../.gitbook/assets/ETW (1).png" alt=""><figcaption></figcaption></figure>



ETW follows a **publish-subscribe** model with the following key components:

#### 1. **Controllers**

* Manage ETW trace sessions.
* Enable or disable providers.
* Examples: `logman.exe` (built-in utility for managing ETW logs).

#### 2. **Providers**

Generate and log events. There are four types of providers:

* **MOF Providers**: Use Managed Object Format (MOF) schemas to define events.
* **WPP Providers**: Use Windows Software Trace Preprocessor (WPP) macros in source code for event generation.
* **Manifest-based Providers**: Define events using XML manifests for flexibility.
* **TraceLogging Providers**: Utilize the TraceLogging API for simplified event generation.

#### 3. **Consumers**

* Subscribe to events for processing and analysis.
* Events are stored in `.ETL` (Event Trace Log) files for offline analysis.
* Consumers can also access events via Windows API.

#### 4. **Channels**

* Logical containers that help organize and filter events.
* Consumers subscribe to specific channels based on event importance.

#### 5. **ETL Files**

* Store event logs for forensic analysis and archival.
* ETW supports efficient log rotation and management.

## Additional Notes

* Some ETW providers are disabled by default to reduce resource consumption.
* Only ETW provider events with a **Channel property** can be consumed by the event log.
* ETW can be extended through **custom event providers**.

***

## Tools for Working with ETW

* **PowerShell (**`**Get-WinEvent**`**)**: Retrieve and filter ETW logs.
* **Microsoft Message Analyzer**: Advanced event parsing and correlation.
* **Windows Performance Analyzer (WPA)**: Analyze system performance using ETW logs.

***

## Interacting With ETW

Logman is a pre-installed utility for managing Event Tracing for Windows (ETW) and Event Tracing Sessions. This tool is invaluable for creating, initiating, halting, and investigating tracing sessions.

`-ets` parameter will allow for a direct investigation of the event tracing sessions, providing insights into system-wide tracing sessions

```cmd-session
C:\Tools> logman.exe query -ets

Data Collector Set                      Type                          Status
-------------------------------------------------------------------------------
Circular Kernel Context Logger          Trace                         Running
Eventlog-Security                       Trace                         Running
DiagLog                                 Trace                         Running
Diagtrack-Listener                      Trace                         Running
EventLog-Application                    Trace                         Running
EventLog-Microsoft-Windows-Sysmon-Operational Trace                         Running
EventLog-System                         Trace                         Running
LwtNetLog                               Trace                         Running
Microsoft-Windows-Rdp-Graphics-RdpIdd-Trace Trace                         Running
NetCore                                 Trace                         Running


The command completed successfully.

```

When we examine an Event Tracing Session directly, we uncover specific session details including the Name, Max Log Size, Log Location, and the subscribed providers. This information is invaluable for incident responders.

For each provider subscribed to the session, we can acquire critical data:

* `Name / Provider GUID`: This is the exclusive identifier for the provider.
* `Level`: This describes the event level, indicating if it's filtering for warning, informational, critical, or all events.
* `Keywords Any`: Keywords create a filter based on the kind of event generated by the provider.

```cmd-session
C:\Tools> logman.exe query "EventLog-System" -ets


Name:                 EventLog-System
Status:               Running
Root Path:            %systemdrive%\PerfLogs\Admin
Segment:              Off
Schedules:            On
Segment Max Size:     100 MB

Name:                 EventLog-System\EventLog-System
Type:                 Trace
Append:               Off
Circular:             Off
Overwrite:            Off
Buffer Size:          64
Buffers Lost:         0
Buffers Written:      47
Buffer Flush Timer:   1
Clock Type:           System
File Mode:            Real-time

Provider:
Name:                 Microsoft-Windows-FunctionDiscoveryHost
Provider Guid:        {538CBBAD-4877-4EB2-B26E-7CAEE8F0F8CB}
Level:                255
KeywordsAll:          0x0
KeywordsAny:          0x8000000000000000 (System)
Properties:           65
Filter Type:          0

Provider:
Name:                 Microsoft-Windows-Subsys-SMSS
Provider Guid:        {43E63DA5-41D1-4FBF-ADED-1BBED98FDD1D}
Level:                255
KeywordsAll:          0x0
KeywordsAny:          0x4000000000000000 (System)
Properties:           65
Filter Type:          0

Provider:
Name:                 Microsoft-Windows-Kernel-General
Provider Guid:        {A68CA8B7-004F-D7B6-A698-07E2DE0F1F5D}
Level:                255
KeywordsAll:          0x0
KeywordsAny:          0x8000000000000000 (System)
Properties:           65
Filter Type:          0

Provider:
Name:                 Microsoft-Windows-FilterManager
Provider Guid:        {F3C5E28E-63F6-49C7-A204-E48A1BC4B09D}
Level:                255
KeywordsAll:          0x0
KeywordsAny:          0x8000000000000000 (System)
Properties:           65
Filter Type:          0

--- SNIP ---

The command completed successfully.
```

By using the `logman query providers` command, we can generate a list of all available providers on the system, including their respective GUIDs.

```cmd-session
C:\Tools> logman.exe query providers

Provider                                 GUID
-------------------------------------------------------------------------------
ACPI Driver Trace Provider               {DAB01D4D-2D48-477D-B1C3-DAAD0CE6F06B}
Active Directory Domain Services: SAM    {8E598056-8993-11D2-819E-0000F875A064}
Active Directory: Kerberos Client        {BBA3ADD2-C229-4CDB-AE2B-57EB6966B0C4}
Active Directory: NetLogon               {F33959B4-DBEC-11D2-895B-00C04F79AB69}
ADODB.1                                  {04C8A86F-3369-12F8-4769-24E484A9E725}
ADOMD.1                                  {7EA56435-3F2F-3F63-A829-F0B35B5CAD41}
Application Popup                        {47BFA2B7-BD54-4FAC-B70B-29021084CA8F}
Application-Addon-Event-Provider         {A83FA99F-C356-4DED-9FD6-5A5EB8546D68}
ATA Port Driver Tracing Provider         {D08BD885-501E-489A-BAC6-B7D24BFE6BBF}
AuthFw NetShell Plugin                   {935F4AE6-845D-41C6-97FA-380DAD429B72}
```

Windows 10 includes more than 1,000 built-in providers. Moreover, Third-Party Software often incorporates its own ETW providers, especially those operating in Kernel mode.

Because of the high humber of providers, use the **findstr** command to filter the one you need

```cmd-session
C:\Tools> logman.exe query providers | findstr "Winlogon"
Microsoft-Windows-Winlogon               {DBE9B383-7CF3-4331-91CC-A3CB16A3B538}
Windows Winlogon Trace                   {D451642C-63A6-11D7-9720-00B0D03E0347}
```

By specifying a provider with Logman, we gain a deeper understanding of the provider's function. This will inform us about the Keywords we can filter on, the available event levels, and which processes are currently utilizing the provider.

```cmd-session
C:\Tools> logman.exe query providers Microsoft-Windows-Winlogon

Provider                                 GUID
-------------------------------------------------------------------------------
Microsoft-Windows-Winlogon               {DBE9B383-7CF3-4331-91CC-A3CB16A3B538}

Value               Keyword              Description
-------------------------------------------------------------------------------
0x0000000000010000  PerfInstrumentation
0x0000000000020000  PerfDiagnostics
0x0000000000040000  NotificationEvents
0x0000000000080000  PerfTrackContext
0x0000100000000000  ms:ReservedKeyword44
0x0000200000000000  ms:Telemetry
0x0000400000000000  ms:Measures
0x0000800000000000  ms:CriticalData
0x0001000000000000  win:ResponseTime     Response Time
0x0080000000000000  win:EventlogClassic  Classic
0x8000000000000000  Microsoft-Windows-Winlogon/Diagnostic
0x4000000000000000  Microsoft-Windows-Winlogon/Operational
0x2000000000000000  System               System

Value               Level                Description
-------------------------------------------------------------------------------
0x02                win:Error            Error
0x03                win:Warning          Warning
0x04                win:Informational    Information

PID                 Image
-------------------------------------------------------------------------------
0x00001710
0x0000025c


The command completed successfully.
```

The `Microsoft-Windows-Winlogon/Diagnostic` and `Microsoft-Windows-Winlogon/Operational` keywords reference the event logs generated from this provider.

***

## GUI-based alternatives

1. Performance Monitor
2. &#x20;[EtwExplorer project](https://github.com/zodiacon/EtwExplorer)

***

## Useful ETW Providers:

* **Microsoft-Windows-Kernel-Process**: Tracks process activities, useful for detecting malware techniques like injection or hollowing.
* **Microsoft-Windows-Kernel-File**: Monitors file operations for unauthorized access or ransomware activity.
* **Microsoft-Windows-Kernel-Network**: Detects network-based attacks, such as exfiltration or C2 communication.
* **Microsoft-Windows-SMBClient/SMBServer**: Monitors SMB traffic for signs of lateral movement or data exfiltration.
* **Microsoft-Windows-DotNETRuntime**: Identifies anomalies in .NET application execution or malicious assembly loading.
* **OpenSSH**: Tracks SSH connections and authentication attempts, useful for detecting brute force attacks.
* **Microsoft-Windows-VPN-Client**: Monitors VPN client events for unauthorized connections.
* **Microsoft-Windows-PowerShell**: Detects suspicious PowerShell activity and misuse.
* **Microsoft-Windows-Kernel-Registry**: Monitors registry changes linked to malware installation or persistence.
* **Microsoft-Windows-CodeIntegrity**: Tracks code and driver integrity, identifying unsigned or malicious code.
* **Microsoft-Antimalware-Service**: Detects issues with antimalware services, like evasion or disabled protection.
* **WinRM**: Monitors remote management activity for signs of lateral movement or remote execution.
* **Microsoft-Windows-TerminalServices-LocalSessionManager**: Tracks local Terminal Services sessions for unauthorized remote desktop activity.
* **Microsoft-Windows-Security-Mitigations**: Tracks security mitigations to identify bypass attempts.
* **Microsoft-Windows-DNS-Client**: Monitors DNS activity to detect DNS-based attacks or C2 communication.
* **Microsoft-Antimalware-Protection**: Tracks antimalware protection for evasion or disabled features.

***

Certain ETW providers in Windows are "restricted," offering valuable telemetry that is only accessible to processes with specific permissions, ensuring sensitive system data is protected.

One of these high-value, restricted providers is `Microsoft-Windows-Threat-Intelligence`. This provider offers crucial insights into potential security threats and is often leveraged in Digital Forensics and Incident Response (DFIR) operations.

Access to this provider requires **Protected Process Light (PPL)** permissions, typically granted to anti-malware vendors after a thorough application process with Microsoft.

> \[!NOTE] According to Elastic: To be able to run as a PPL, an anti-malware vendor must apply to Microsoft, prove their identity, sign binding legal documents, implement an Early Launch Anti-Malware (ELAM) driver, run it through a test suite, and submit it to Microsoft for a special Authenticode signature. It is not a trivial process. Once this process is complete, the vendor can use this ELAM driver to have Windows protect their anti-malware service by running it as a PPL.&#x20;
>
> With that said, [workarounds to access the `Microsoft-Windows-Threat-Intelligence` provider exist](https://posts.specterops.io/uncovering-windows-events-b4b9db7eac54).

***

## Useful Links

https://web.archive.org/web/20231030010850/https://bmcder.com/blog/a-begginers-all-inclusive-guide-to-etw
